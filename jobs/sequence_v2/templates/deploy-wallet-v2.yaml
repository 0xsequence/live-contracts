name: "deploy-wallet-v2"
version: "2"

arguments:
  implementation:
    type: "address"
  salt:
    type: "bytes32"

returns:
  address:
    type: "address"

setup:
  - type: "job-completed"
    arguments:
      job: "sequence-v2"

# Use the checked-call pattern
# or else the call can fail due to low gas
actions:
  - type: "create-contract"
    arguments:
      data:
        type: "abi-pack"
        arguments:
          types:
            - "bytes"
            - "address"
            - "address"
            - "bytes"
          values:
            - "0x383d8039602c5160601c3d813b60295780806054380360548260405160601c5af150903b60295780fd5b80f3" # checked-call.huff
            - type: "compute-create2"
              arguments:
                deployerAddress: "{{sequence-v2.factory.address}}"
                salt: "{{salt}}"
                initCode:
                  type: "constructor-encode"
                  arguments:
                    creationCode: "0x603a600e3d39601a805130553df3363d3d373d3d3d363d30545af43d82803e903d91601857fd5bf3"
                    types: ["address"]
                    values: ["{{implementation}}"]
            - "{{sequence-v2.factory.address}}"
            - type: "abi-encode"
              arguments:
                signature: "deploy(address,bytes32)"
                values:
                  - "{{implementation}}"
                  - "{{salt}}"

skip_condition:
  - type: "contract-exists"
    arguments:
      address:
        type: "compute-create2"
        arguments:
          deployerAddress: "{{sequence-v2.factory.address}}"
          salt: "{{salt}}"
          initCode:
            type: "constructor-encode"
            arguments:
              creationCode: "0x603a600e3d39601a805130553df3363d3d373d3d3d363d30545af43d82803e903d91601857fd5bf3"
              types: ["address"]
              values: ["{{implementation}}"]

outputs:
  address:
    type: "compute-create2"
    arguments:
      deployerAddress: "{{sequence-v2.factory.address}}"
      salt: "{{salt}}"
      initCode:
        type: "constructor-encode"
        arguments:
          creationCode: "0x603a600e3d39601a805130553df3363d3d373d3d3d363d30545af43d82803e903d91601857fd5bf3"
          types: ["address"]
          values: ["{{implementation}}"]