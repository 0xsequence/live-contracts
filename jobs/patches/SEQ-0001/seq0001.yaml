name: "SEQ-0001"
version: "1"
description: "Patch sequence vulnerability SEQ-0001"
depends_on: ["era-evm-predeploy-erc2470", "era-evm-predeploy-universal", "sequence-v1", "guards-v1", "sequence-v2", "guards-v2"]

actions:
  - name: "sequence-main-module-upgradable-duo-v1"
    template: "sequence-universal-deployer-2"
    arguments:
      salt: "{{salt-zero}}"
      creationCode: "{{Contract(./build-info/sequence-main-module-upgradable-duo-v1.json:MainModuleUpgradableDuo).creationCode}}"
    output: true

  - name: "sequence-main-module-upgradable-duo-v2"
    template: "erc-2470"
    arguments:
      salt: "{{salt-zero}}"
      creationCode: "{{Contract(./build-info/sequence-main-module-upgradable-duo-v2.json:MainModuleUpgradableDuo).creationCode}}"
    output: true

  - name: "verify-sequence-main-module-upgradable-duo-v1"
    type: "verify-contract"
    arguments:
      address: "{{sequence-main-module-upgradable-duo-v1.address}}"
      contract: "{{Contract(./build-info/sequence-main-module-upgradable-duo-v1.json:MainModuleUpgradableDuo)}}"
    output: false

  - name: "verify-sequence-main-module-upgradable-duo-v2"
    type: "verify-contract"
    arguments:
      address: "{{sequence-main-module-upgradable-duo-v2.address}}"
      contract: "{{Contract(./build-info/sequence-main-module-upgradable-duo-v2.json:MainModuleUpgradableDuo)}}"
    output: false

  - type: json-request
    name: get-guard-v1-signature
    arguments:
      url: "https://guard.sequence.app/rpc/Guard/Patch"
      method: "POST"
      headers:
        Content-Type: "application/json"
      body:
        type: "resolve-json"
        arguments:
          signer: "0x596aF90CecdBF9A768886E771178fd5561dD27Ab"
          chainId: "{{Network().chainId}}"
          secret: "werunalittlepatch"

  - name: "patch-guard-v1" # Sends a pre-signed transaction performing the migration
    template: "send-transaction"
    skip_condition: # Nonce space 100 is used for patching
      - type: "basic-arithmetic"
        arguments:
          operation: "gte"
          values:
            - type: "call"
              arguments:
                to: "{{guards-v1.prod-guard.address}}"
                signature: "readNonce(uint256) returns (uint256)"
                values: ["100"]
            - "1"
    arguments:
      to: "{{guards-v1.prod-guard.address}}"
      data:
        type: read-json
        arguments:
          json: "{{get-guard-v1-signature.response}}"
          path: "txs.data"

  - name: "patch-guard-v2" # Sends a pre-signed transaction performing the migration
    template: "send-transaction"
    skip_condition: # Nonce space 100 is used for patching
      - type: "basic-arithmetic"
        arguments:
          operation: "gte"
          values:
            - type: "call"
              arguments:
                to: "{{guards-v2.prod-guard.address}}"
                signature: "readNonce(uint256) returns (uint256)"
                values: ["100"]
            - "1"
    arguments:
      to: "{{guards-v2.prod-guard.address}}"
      data: "0x7a9a1628000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000640000000000000000000000000000000000000000000000000000000000000000000000000000000000000b200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000009a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004c4b40000000000000000000000000ce0042b868300000d44a59004da54a005ffdcf9f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000008644af63f020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007fb61010060405234801561001157600080fd5b5060405161077b38038061077b833981016040819052610030916100ab565b8161004e57604051634294d12760e01b815260040160405180910390fd5b8061006c57604051635925ad9d60e11b815260040160405180910390fd5b6001600160a01b039384166080529190921660a05260c09190915260e0526100ee565b80516001600160a01b03811681146100a657600080fd5b919050565b600080600080608085870312156100c157600080fd5b6100ca8561008f565b93506100d86020860161008f565b6040860151606090960151949790965092505050565b60805160a05160c05160e051610602610179600039600081816101010152818161029701528181610330015281816104b6015261050e01526000818160cc01528181610254015281816102dd015281816103ef015261052f01526000818161012801526101620152600081816071015281816101bb0152818161022f015261055001526106026000f3fe608060405234801561001057600080fd5b50600436106100675760003560e01c8063a685412f11610050578063a685412f146100c7578063c457179f146100fc578063cc1f2afa1461012357600080fd5b80633a4741bd1461006c5780638fd3ab80146100bd575b600080fd5b6100937f000000000000000000000000000000000000000000000000000000000000000081565b60405173ffffffffffffffffffffffffffffffffffffffff90911681526020015b60405180910390f35b6100c561014a565b005b6100ee7f000000000000000000000000000000000000000000000000000000000000000081565b6040519081526020016100b4565b6100ee7f000000000000000000000000000000000000000000000000000000000000000081565b6100937f000000000000000000000000000000000000000000000000000000000000000081565b3073ffffffffffffffffffffffffffffffffffffffff7f000000000000000000000000000000000000000000000000000000000000000016146101b9576040517f65ec05a200000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff163b60000361022a576040517f5c0f897a00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6102527f00000000000000000000000000000000000000000000000000000000000000003055565b7f00000000000000000000000000000000000000000000000000000000000000007fea7157fa25e3aa17d0ae2d5280fa4e24d421c61842aa85e45194e1145aa72bf8557f00000000000000000000000000000000000000000000000000000000000000007f8c8764b3a50fee69c9bee6e956047501f434fb0e2349c75844a401a7f2a020d2556040517f000000000000000000000000000000000000000000000000000000000000000081527f307ed6bd941ee9fc80f369c94af5fa11e25bab5102a6140191756c5474a30bfa9060200160405180910390a16040517f000000000000000000000000000000000000000000000000000000000000000081527f1f63199319eff813052575c41087f618aba07b006664fed6c01f7ee9c57168359060200160405180910390a13073ffffffffffffffffffffffffffffffffffffffff166351605d806040518163ffffffff1660e01b8152600401602060405180830381865afa1580156103c9573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906103ed91906105b3565b7f000000000000000000000000000000000000000000000000000000000000000014610445576040517fa7b8a79400000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b3073ffffffffffffffffffffffffffffffffffffffff16639bd58b166040518163ffffffff1660e01b8152600401602060405180830381865afa158015610490573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906104b491906105b3565b7f00000000000000000000000000000000000000000000000000000000000000001461050c576040517f65b38a3c00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b7f00000000000000000000000000000000000000000000000000000000000000007f00000000000000000000000000000000000000000000000000000000000000007f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff167f6607576bea396d17e738405e5d77e671ba7dc07aaff57dc414927d313fd530c360405160405180910390a4565b6000602082840312156105c557600080fd5b505191905056fea264697066735822122068f711d4a7204b5814b364091d1a082f7e0b7b9588b0908166d01a5ca3d86c4164736f6c634300081200330000000000000000000000004f8ce847174b32cbe21b3887be894e0debc28952000000000000000000000000761f5e29944d79d76656323f106cf2efbf5f09e9acb659ac7f85fbbce197005235ced2d040c7b02942a9dfae647582393d5a4e836e2f52838722eda7d569b52db277d0d87d36991a6aa9b9657ef9d8f09b0c33f4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000775ef49ff34b6078109df0388d8f62ef4debb1df000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000048fd3ab80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000061020001000000000001cc26074d5b619bca93ba7c0d7228d5fce7a9ddb8594515767d79fe337355f2d13911df4988dd7de1879c70afa1d0fa2503de48a2873b034189ecd4239690ed441b02010190d62a32d1cc65aa3e80b567c8c0d3ca0f411e6100000000000000000000000000000000000000000000000000000000000000"
